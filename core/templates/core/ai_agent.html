{% extends 'core/base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-6 p-4 mt-4">
    
    <div class="md:w-1/4">
        <div class="bg-white p-6 rounded-2xl border border-gray-100 sticky top-24 shadow-xl text-center">
            <div class="w-20 h-20 {% if user.is_superuser %}bg-purple-600{% else %}bg-blue-600{% endif %} text-white rounded-full flex items-center justify-center text-3xl font-bold mx-auto mb-4 border-4 border-gray-50 shadow-inner">
                {% if user.is_superuser %}A{% else %}{{ user.username|first|upper }}{% endif %}
            </div>
            <h3 class="font-bold text-gray-800 text-xl">
                {% if user.is_superuser %}Hospital Admin{% else %}{{ user.patientprofile.full_name|default:user.username }}{% endif %}
            </h3>
            <p class="text-xs font-bold mt-1 uppercase tracking-widest {% if user.is_superuser %}text-purple-600{% else %}text-blue-600{% endif %}">
                {% if user.is_superuser %}System Controller{% else %}Verified Patient{% endif %}
            </p>

            {% if user.is_superuser %}
            <div class="mt-6 space-y-2">
                <a href="/admin/core/doctor/add/" target="_blank" class="block w-full py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs font-bold transition">
                    + ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                </a>
                <a href="/admin/core/blooddonor/add/" target="_blank" class="block w-full py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-bold transition">
                    + ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                </a>
            </div>
            {% endif %}
            
            <div class="mt-6 pt-6 border-t border-gray-100 text-left space-y-3">
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <span class="p-1 bg-green-100 rounded">‚úÖ</span> AI Connection Active
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <span class="p-1 bg-blue-100 rounded">ü§ñ</span> Llama 3.1 (OpenRouter)
                </div>
            </div>
        </div>
    </div>

    <div class="md:w-3/4 flex flex-col h-[75vh] bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden">
        <div class="p-4 bg-gradient-to-r {% if user.is_superuser %}from-purple-700 to-indigo-800{% else %}from-blue-700 to-blue-900{% endif %} text-white flex items-center justify-between shadow-md">
            <div class="flex items-center gap-3">
                <span class="text-2xl animate-bounce">‚ú®</span>
                <div>
                    <h1 class="font-black text-lg uppercase tracking-tight">CareNexus Smart AI</h1>
                    <p class="text-xs opacity-80">‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶Æ‡¶ø ‡¶∏‡¶∞‡ßç‡¶¨‡¶¶‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§</p>
                </div>
            </div>
            <span class="px-3 py-1 bg-white/20 rounded-full text-xs animate-pulse">Online</span>
        </div>

        <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50 flex flex-col">
            <div class="flex justify-start">
                <div class="bg-white border border-gray-200 text-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm max-w-[80%]">
                    ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! ‡¶Ü‡¶Æ‡¶ø ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞‡¶®‡ßá‡¶ï‡ßç‡¶∏‡¶æ‡¶∏ ‡¶è‡¶Ü‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶π‡¶æ‡¶∏‡¶™‡¶æ‡¶§‡¶æ‡¶≤‡ßá‡¶∞ ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞, ‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶¨‡¶æ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡•§
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-gray-100">
            <form id="ai-form" class="flex gap-2">
                {% csrf_token %}
                <input type="text" id="user-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." 
                    class="flex-1 p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-gray-50"
                    autocomplete="off">
                <button type="submit" id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg flex items-center justify-center min-w-[120px]">
                    Send
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const aiForm = document.getElementById('ai-form');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    function appendMessage(sender, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = sender === 'user' ? 'flex justify-end mb-2' : 'flex justify-start mb-2';
        const innerDiv = document.createElement('div');
        innerDiv.className = sender === 'user' 
            ? 'bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-[85%] whitespace-pre-wrap' 
            : 'bg-white border border-gray-200 text-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] whitespace-pre-wrap';
        innerDiv.innerText = text;
        msgDiv.appendChild(innerDiv);
        chatBox.appendChild(msgDiv);
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    aiForm.onsubmit = async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        appendMessage('user', message);
        userInput.value = '';
        sendBtn.disabled = true;
        sendBtn.innerText = "Wait...";

        try {
            const response = await fetch("{% url 'ask_ai' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({ 'message': message })
            });
            const data = await response.json();
            appendMessage('ai', data.reply);
        } catch (error) {
            appendMessage('ai', "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§");
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerText = "Send";
        }
    };
</script>
{% endblock %}