{% extends 'core/base.html' %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-white p-6 rounded-xl shadow-md h-fit">
        <h2 class="text-xl font-bold mb-4 text-blue-700">Patient Profile</h2>
        <p class="text-gray-700"><strong>Name:</strong> {{ request.user.patientprofile.full_name }}</p>
        <p class="text-gray-700"><strong>ID:</strong> {{ request.user.username }}</p>
        <hr class="my-4">
        <a href="/admin" class="text-sm text-blue-500 underline">Update Info</a>
    </div>

    <div class="md:col-span-2 bg-white rounded-xl shadow-lg flex flex-col h-[500px]">
        <div class="bg-blue-600 p-4 rounded-t-xl text-white font-bold">
            CareNexus AI Assistant
        </div>
        
        <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50">
            <div class="bg-blue-100 p-3 rounded-lg w-fit max-w-[80%]">
                Hello! I am your Clinical Assistant. How can I help you today?
            </div>
        </div>

        <form id="chat-form" class="p-4 border-t flex gap-2">
            {% csrf_token %}
            <input type="text" id="user-input" class="flex-1 border rounded-lg px-4 py-2 focus:outline-none" placeholder="Ask about doctors, blood donors or health tips...">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Send</button>
        </form>
    </div>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const chatBox = document.getElementById('chat-box');

    chatForm.onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById('user-input');
        const message = input.value;
        if(!message) return;

        // ইউজারের মেসেজ স্ক্রিনে দেখানো
        chatBox.innerHTML += `<div class="bg-gray-200 p-3 rounded-lg w-fit ml-auto max-w-[80%]">${message}</div>`;
        input.value = '';

        // সার্ভারে পাঠানো (এই ভিউটা আমরা পরের ধাপে তৈরি করব)
        const response = await fetch('/ask-ai/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({'message': message})
        });
        const data = await response.json();
        
        // AI এর উত্তর দেখানো
        chatBox.innerHTML += `<div class="bg-blue-100 p-3 rounded-lg w-fit max-w-[80%]">${data.reply}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    };
</script>
{% endblock %}